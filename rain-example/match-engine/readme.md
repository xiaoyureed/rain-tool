## Concepts

```

撮合引擎业务流程:

- 系统开放某交易标的的交易功能
- 用户提交该标的的买卖申报(委托单)
- 引擎校验委托单是否有效
    - 标的是否处于可交易状态
    - 委托单中的 价格/数量是否满足要求
- 确定该委托单的 挂单(Maker)/吃单(Taker) 的费率
- 检查用户的账户资金情况, 如账户是否交易受限, 资金是否充足
- 将详细的委托单数据 持久化保存(数据库/Redis...), 并冻结用账户中相应数量的资金
- 将委托单进行撮合处理, 即在 交易委托账本(OrderBoo) 中寻找能够与该委托单匹配成交的订单
    匹配的结果: 
        全部成交: 委托单完全被消化
        部分成交: 委托单部分被消化
        无匹配: 无法在 OrderBoo 找到匹配的订单
    
    (全部/部分成交意味着 OrderBoo 中存在一个/多个匹配的订单, 会产生一个/多个成交记录)
    (无匹配/部分成交 意味着委托单未消化完, 未消化的数量会挂在OrderBook 中等待与后续的委托单进行撮合匹配)

- 将撮合产生的成交记录持久化保存形成历史数据, 根据记录生成市场数据, 如 k 线图, 今日涨跌幅
- 更新数据库中委托单数据, 用户账户数据, 如成交状态, 冻结资金状态, 账户资金情况
     




集合竞价: 对一段时间内收到的委托单, 一次性集中撮合, 目的就是确定一个基准价格

    例如股票市场, 每天9:15-9:25 是集合竞价时间, 这段时间, 收到的委托单不会立刻处理, 而是将所有委托单按照价格, 时间的优先级排序,
    在此基础上, 找出一个基准价格,  该价格满足:
    
    - 可实现最大成交量
    - 委托单中, 买单高于该价格, 全部成交, 卖单低于该价格, 全部成交
    
    集合竞价时间结束, 未成交的委托单, 进入连续竞价


连续竞价: 买卖委托单逐笔连续撮合的竞价方式, 只要满足条件, 立即成交




性能(tps): 每秒能处理多少笔委托单 (假设每个委托单都有相同交易对)

    基于数据库撮合:  tps 一般在 10笔/s
    基于内存撮合:  tps 一般在 1000笔/s


可伸缩性: 将多个撮合引擎节点部署未集群, 每个节点处理某个特定标的

```

## Architecture

```
           +----------------------------------------------------------+             
           |                 match cluster                            |             
           |                                          +----------+    |             
           | +-------------+    +------------+        |          |    |             
           | | match       |    | match      |        | match    |    |             
           | | service     |    | service    |        | service  |    |             
           | |             |    |            |        |          |    |             
           | +-------------+    |            |        +----------+    |             
           |                    +------------+                        |             
           +----------------------------------------------------------+             
                             |     |     |                                          
                             |     |     |   交易委托单                                  
                             v     v     v                                          
                  +------------------------------------------+                      
                  |                                          |                      
                  |                 MQ                       |                      
                  |                                          |                      
                  +------------------------------------------+                      
                                    |                                               
+-------------+                     |                                               
|   DB        |   import            v                                               
|  initial    |            +-------------------+                                    
|  data       |   -------> |                   |                                    
|             |            |                   |                grab                
|             |            |    RingBuffer     | ----------------------------+      
|             |            |                   |                             |      
+-------------+            |  (Disruptor )     |--------+                    |      
                           |                   |        |                    |      
          +--------------  |                   |        | grab               |      
          |  grab          +-------------------+        |                    |      
          |                      | grab                 |                    |      
 +--------|----------------------|----------------------|--------------------|-----+
 |        v                      v                      v                    v     |
 |  +-----------+           +------------+        +-------------+   +------------+ |
 |  | cpu       |           | cpu        |        |             |   |   cpu      | |
 |  | (ETH/BTC) |           | (ETH/SOL)  |        |  cpu        |   |            | |
 |  |           |           |            |        |             |   |            | |
 |  +-----------+           +------------+        +-------------+   +------------+ |
 +---------------------------------------------------------------------------------+

```
